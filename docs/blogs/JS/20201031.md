---
title: js中request的同步执行
date: 2020-10-31
tags:
 - 踩坑
 - 异步
 - 同步
categories:
 - node.js
---

### Node.js 中 JavaScript 代码的执行顺序

​	**从开始执行的时间点上来看，Node.js 中的所有语句都是顺序执行的。**但是，由于 Node.js 的异步特性，先开始执行并不意味着先执行完毕。这就造成了 Node.js 似乎没有顺序执行的假象。单线程和异步确实不能同时成为一个语言的特性。js选择了成为单线程的语言，所以它本身不可能是异步的，但js的宿主环境（比如浏览器，Node）是多线程的，宿主环境通过某种方式（事件驱动，下文会讲）使得js具备了异步的属性。往下看，你会发现js的机制是多么的简单高效！

### Promise

#### 用法

1.创建Promise实例

```javascript
var promise = new Promise(function(resolve, reject){
    // ... some code
    
    if (/* 异步操作成功 */) {
        resolve(value);
    } else {
        reject(error);
    }
})
```

2.then

 Promise实例生成后，可用`then`方法分别指定两种状态回调参数。then 方法可以接受两个回调函数作为参数：

①Promise对象状态改为Resolved时调用 （必选）

②Promise对象状态改为Rejected时调用 （可选）

示例：

```javascript
let promise = new Promise(function(resolve, reject){
    console.log("AAA");
    resolve()
});
promise.then(() => console.log("BBB"));
console.log("CCC")

// AAA
// CCC
// BBB
```

Promise新建后会立即执行，所以`首先输出 AAA`。然后，then方法指定的回调函数将在当前脚本所有同步任务执行完后才会执行，所以`BBB 最后输出`

```javascript
const { resolve } = require('path');
var request = require('request');
const GET = 'GET';
const POST = 'POST';
const PUT = 'PUT';
const FORM = 'FORM';
const DELETE = 'DELETE';
function request1(method, url, data) {
    request({
        timeout: 5000,
        method: method,
        url: url,
        form: data
    }, async function (error, response, body) {
        if (!error && response.statusCode == 200) {
            body_json = JSON.parse(body);
            console.error(body_json.status);
            if (method == POST) {
                if (body_json.status) {
                    var responseCookies = response.headers['set-cookie'];
                    console.info("获取cookie");
                    return 222;
                }
                else {
                    console.error("???");
                    return;
                }
            }
            else {
                return body;
            }
        }
        else {
            return;
            console.log("error");
        }
    }
    );
}

url="https://passport2.chaoxing.com/fanyalogin"//登录
num='17860823569'
psw='cat000123@'
pwd=new Buffer(psw).toString('base64');
let data={
    'uname': num,
    'password': pwd,
    't': 'true'
}
// var res= request1(POST,url,data);
// // setTimeout(function(){
// //     console.log(request1(POST,url,data));
// // },5000);
// console.error(res)
// request1(POST,url,data).then(x=>console.log(x))
function requestpromise(method, url, data){
    return new Promise((resolve, reject)=>{
        request({
            timeout: 5000,
            method: method,
            url: url,
            form: data
        },function(error,response,body){
            if (!error && response.statusCode == 200) {
                resolve(body)
            }
        })
    })
}
 a=requestpromise(POST,url,data).then(function(req){
    return req
})
console.log(a)
```

```javascript

```

https://www.cnblogs.com/chenqionghe/p/11406666.html#%E4%BA%8C%E3%80%81%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8-then%E6%96%B9%E6%B3%95

https://blog.csdn.net/qingqingzijinxin/article/details/89095820

https://www.imooc.com/wenda/detail/498801